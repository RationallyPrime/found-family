| Improvement                                                                                 | Why it helps                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Evidence from repository                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **1. Consolidate and simplify the query endpoints**                                         | The repository exposes multiple endpoints for building and executing Cypher queries: `/api/v1/memory/query` in `memory.py` and `/api/v1/query/build` and `/api/v1/query/direct` in `query.py`.  Both endpoints assemble Cypher queries via `CypherQueryBuilder` and include similar features (match patterns, where clauses, similarity search, specification-based filters and ordering).  This duplication increases surface area and forces users to learn different request models.  Creating a single unified query endpoint (for example `/api/v1/query`) with a flexible request model that covers match patterns, filters (min\_salience, topic\_ids, conversation\_id, memory\_types), similarity search and ordering would simplify the API and eliminate confusing duplication.  Provide an option (e.g., `explain=true`) to return the generated query and parameters without executing.                                                                                                                                                                                                                                                                                                                                                                                            | The `build_and_execute_query` endpoint in `query.py` manually loops through `match_patterns` and `where_conditions`, applies similarity and specification filters, and executes the query.  The `execute_query_builder` endpoint in `memory.py` does almost the same work for memory queries, adding match patterns, similarity search and relationship traversal.  Consolidation will reduce code duplication and give API clients a single, consistent way to perform queries.                                                                         |
| **2. Add a declarative JSON query DSL that maps directly to specifications**                | Currently clients must know Cypher syntax or call builder methods indirectly through complicated request models.  Even when using `search_memories`, only simple filters like `min_salience` or `topic_id` can be passed; the rich domain specifications (e.g., `RecentMemorySpecification`, `EmotionalMemorySpecification`, `RelatedMemorySpecification`) are not exposed through the API.  Introduce a JSON DSL for queries where the `filter` section is automatically converted into specification objects (e.g., `{ "filter": { "min_salience": 0.7, "topic_ids": [1,2], "recent_days": 7, "emotions": ["happy"] } }`).  The server can then compose these specifications via logical AND/OR, call `spec.to_cypher()` when available, and plug them into the query builder using `where_spec` from `specification_support`.  Combining this with optional `similarity_search` parameters and return settings would give clients powerful expressive queries without requiring any Cypher knowledge.                                                                                                                                                                                                                                                                                        | The `recall_with_specifications` method in `MemoryService` shows how multiple specification objects can be applied to a builder: it loops through each spec, calls `spec.to_cypher()` and adds it as a `WHERE` clause.  `specification_support` also allows fallback to filter dictionaries.  Exposing a simple JSON DSL that maps onto these specification objects would let the API integrate the specification pattern directly and hide the lower‑level details.                                                                                     |
| **3. Provide higher‑level helper methods and improved error handling in the query builder** | The `CypherQueryBuilder` is powerful but requires clients (and endpoint code) to understand its internal state machine and to build patterns using lambdas: e.g., `builder.match(lambda p: p.node("Memory","n", id=id))`.  This low‑level API leaks complexity to users.  A few small improvements can greatly increase usability: **(a)** add helper functions such as `match_node(label, alias, **props)` and `match_relationship(source_alias, rel_type, target_alias)` to eliminate lambdas and make queries self‑explanatory; **(b)** integrate the `SpecificationSupport` mixin into `CypherQueryBuilder` so that `builder.where_spec(spec)` can be called directly; **(c)** expose vector search helpers (the `VectorSearchMixin` already provides `vector_search`, `hybrid_search`, etc.) through the builder so that similarity search can be added with a single call; **(d)** enhance the state machine to provide user‑friendly error messages or an `explain()` method—currently, errors like adding a `WHERE` clause before a `MATCH` are validated internally by `CypherQueryState`, but the API doesn’t surface suggestions.  Exposing a `validate()` endpoint that returns permissible next clauses and a descriptive message would help developers compose queries correctly. | The builder requires complex lambdas for pattern creation and manual calls to `where_param` and `with_clause` for similarity search.  While the `SpecificationSupport` mixin exists, it isn’t integrated by default, forcing code in `recall_with_specifications` to manually loop through specs and call `to_cypher()`.  `CypherQueryState` tracks valid clause sequences but doesn’t expose guidance to users.  Adding these helpers and better error feedback would make the query builder’s fluent API more approachable and reduce subtle mistakes. |
